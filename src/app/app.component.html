@if (!room()) {
<div id="join">
    <div id="join-dialog">
        <h2>Join a Room</h2>

        <form [formGroup]="roomForm" (ngSubmit)="joinRoom()">
            <div>
                <label for="participant-name">Participant</label>
                <input formControlName="participantName" id="participant-name" class="form-control" type="text" />
            </div>

            <div>
                <label for="room-name">Room</label>
                <input formControlName="roomName" id="room-name" class="form-control" type="text" />
            </div>

            <button class="btn btn-lg btn-success" type="submit" [disabled]="!roomForm.valid">Join!</button>
        </form>
    </div>
</div>
} @else {
<div id="room">
    <div id="room-header">
        <h2 id="room-title">{{ roomForm.value.roomName }}</h2>
        <div class="header-actions">
            <!-- <button class="btn btn-primary" (click)="toggleCamAndShare()" [disabled]="!room()">
                {{ camAndShare ? "Stop Cam + Share" : "Start Cam + Share" }}
            </button> -->
            <!-- <button class="btn btn-outline-primary" (click)="flipCamera()" [disabled]="!room()">Flip Cam</button> -->
            <!-- <button
                class="btn btn-outline-success"
                (click)="startRecording('localOnly')"
                [disabled]="!room() || isRecording"
            >
                Record (Local)
            </button>
            <button
                class="btn btn-outline-success"
                (click)="startRecording('localPlusRemote')"
                [disabled]="!room() || isRecording"
            >
                Record (Local + Remote)
            </button> -->
            <button
                class="btn btn-outline-success"
                (click)="startRecording('screenShare')"
                [disabled]="!room() || isRecording"
            >
                Record (Screen)
            </button>
            <button class="btn btn-outline-danger" (click)="stopRecording()" [disabled]="!room() || !isRecording">
                Stop Record
            </button>
            <button class="btn btn-secondary" (click)="toggleScreenShare()" [disabled]="!room()">
                {{ isScreenSharing ? "Stop Share" : "Share Screen" }}
            </button>
            <button class="btn btn-outline-warning" (click)="toggleMic()" [disabled]="!room()">
                {{ isMicOn ? "Mute Mic" : "Unmute Mic" }}
            </button>
            <button class="btn btn-outline-info" (click)="toggleCamera()" [disabled]="!room()">
                {{ isCameraOn ? "Turn Camera Off" : "Turn Camera On" }}
            </button>
            <!-- <span class="badge" [class.bg-success]="isMicOn" [class.bg-secondary]="!isMicOn">
                Mic: {{ isMicOn ? "On" : "Muted" }}
            </span> -->
            <button class="btn btn-danger" id="leave-room-button" (click)="leaveRoom()">Leave Room</button>
        </div>
    </div>

    <div id="content">
        <!-- LEFT: participants + videos -->
        <div id="left-pane">
            <div id="participants" class="mt-2">
                @for (p of participants(); track p) {
                <span class="badge bg-secondary me-2">{{ p }}</span>
                }
            </div>

            <div id="layout-container">
                <!-- LOCAL VIDEO (mình) -->
                @if (localCamTrack()) {
                <video-component
                    [track]="localCamTrack()!"
                    [participantIdentity]="room()!.localParticipant.name ?? room()!.localParticipant.identity ?? 'me'"
                    [local]="true"
                >
                </video-component>
                }

                <!-- REMOTE AUDIO/VIDEO -->
                @for (remoteTrack of remoteTracksMap().values(); track remoteTrack.trackPublication.trackSid) { @if
                (remoteTrack.trackPublication.kind === 'audio') {
                <audio-component [track]="remoteTrack.trackPublication.audioTrack!"></audio-component>
                } @else if (remoteTrack.trackPublication.kind === 'video') {
                <video-component
                    [track]="remoteTrack.trackPublication.videoTrack!"
                    [participantIdentity]="remoteTrack.participantIdentity"
                    [local]="false"
                ></video-component>
                } }
            </div>
        </div>

        <!-- RIGHT: Chat -->
        <aside id="chat-panel">
            <h4>Chat</h4>
            <div id="chat-messages">
                @for (msg of messages(); track $index) {
                <div class="chat-line" [class.system-msg]="msg.from === 'Hệ thống'">
                    <b *ngIf="msg.from !== 'Hệ thống'">{{ msg.from }}:</b> {{ msg.text }}
                </div>
                }
            </div>

            <form (ngSubmit)="sendMessage()" id="chat-form">
                <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="chatInput"
                    name="chatInput"
                    placeholder="Type a message..."
                    required
                />
                <button type="submit" class="btn btn-primary mt-2">Send</button>
            </form>

            <div class="mt-2 d-flex gap-2">
                <input
                    type="file"
                    class="form-control"
                    (change)="onFilePicked($event)"
                    [disabled]="!room()"
                    accept="*/*"
                />
            </div>

            <!-- === Danh sách file đã nhận === -->
            <div class="mt-3">
                <h5>Files</h5>

                @if (receivedFiles().length === 0) {
                <div class="text-muted">Chưa có tệp nào.</div>
                } @else {
                <ul class="list-unstyled">
                    @for (f of receivedFiles(); track f.id) {
                    <li class="mb-2">
                        <a [href]="f.url" [download]="f.name">{{ f.name }}</a>
                        <small class="text-muted ms-2">
                            ({{ f.size / 1024 | number : "1.0-0" }} KB) — từ {{ f.from }}
                        </small>
                    </li>
                    }
                </ul>
                }
            </div>
        </aside>
    </div>
</div>
}
